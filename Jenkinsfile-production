node {
    def image
    def imageName = "tvphuong/dashboard-webapp-production"

    stage("Checkout SCM") {
        // Use checkout scm only once for consistency
        checkout scm
    }

    stage("Build Image") {
        image = docker.build("${imageName}:${env.BUILD_NUMBER}")
    }

    stage("Push Image") {
        docker.withRegistry("https://index.docker.io/v1/", "bongao-hub-credentials") {
            image.push()
        }
    }

    stage('Cleaning up') {
        sh "docker rmi $imageName:$env.BUILD_NUMBER"
    }
}